<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Consultium App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Loading overlay */
    #loading-overlay {
      position: fixed; inset: 0;
      background: rgba(255,255,255,0.8);
      display: none;
      align-items: center; justify-content: center;
      z-index: 50;
    }
    .spinner {
      border: 4px solid #3b82f6;
      border-top-color: transparent;
      border-radius: 9999px;
      width: 3rem; height: 3rem;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    body { font-family: 'Inter', sans-serif; background: #f8fafc; }
    .expanding-textarea { min-height: 80px; max-height: 640px; overflow-y: auto; resize: none; padding: 1rem; }
    .formatted-output ul { margin:0 0 .75rem 1.5rem; padding:0; list-style:disc; }
    .formatted-output li { margin-bottom:.5rem; }
    .fade-in { opacity:0; animation:fadeIn .5s ease-out forwards; }
    @keyframes fadeIn { to { opacity:1; } }
  </style>
</head>
<body class="h-screen flex flex-col">
  <!-- Global loader -->
  <div id="loading-overlay" class="flex"><div class="spinner"></div></div>

  <!-- Header -->
  <header class="flex items-center justify-between px-6 py-4 bg-white shadow">
    <img src="static/images/logo.png" alt="Logo" class="h-8" />
    <div class="relative">
      <img src="static/images/default.png" alt="Profiel" class="w-10 h-10 rounded-full cursor-pointer" onclick="toggleMenu()" />
      <div id="dropdown-menu" class="hidden absolute right-0 mt-2 w-48 bg-white shadow-lg rounded">
        <a href="/account" class="block px-4 py-2 hover:bg-gray-100">Account Instellingen</a>
        <a href="index.html" class="block px-4 py-2 hover:bg-gray-100">Uitloggen</a>
      </div>
    </div>
  </header>

  <!-- Recording overlay -->
  <div id="recording-overlay" class="fixed inset-0 hidden z-50 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center">
    <button id="cancel-recording-btn" class="absolute top-6 right-6 text-3xl">&times;</button>
    <canvas id="waveform-canvas" class="w-full max-w-4xl h-40"></canvas>
    <button id="soep-recording-btn" class="mt-8 px-10 py-4 bg-blue-600 text-white text-2xl rounded-full">SOEP</button>
  </div>

  <!-- Main -->
  <main class="flex-1 px-8 py-10 flex flex-col items-center">
    <!-- Input -->
    <div class="w-2/3 bg-white p-6 rounded-3xl shadow border border-gray-200">
      <textarea id="text-input" placeholder="Hier typen..." class="w-full text-lg placeholder-gray-400 bg-transparent outline-none expanding-textarea"></textarea>
      <button id="whisper-btn" class="mt-4 px-4 py-2 bg-blue-100 text-blue-700 rounded-full">üéôÔ∏è Start Opname</button>
    </div>

    <!-- Generate SOEP -->
    <button id="generate-soep" class="mt-4 px-8 py-3 bg-gray-200 rounded-full shadow">SOEP</button>

    <!-- SOEP Output -->
    <div id="verslag-container" class="mt-8 w-2/3 space-y-6 hidden">
      <template id="section-template">
        <div class="bg-white p-6 rounded-3xl shadow border border-gray-200 fade-in">
          <h3 class="text-xl font-semibold mb-4">LETTER</h3>
          <div class="relative">
            <div class="scrollable-box"><div class="formatted-output"></div></div>
            <button class="absolute bottom-4 right-4 px-2 py-1 bg-gray-100 rounded-full">üìã</button>
          </div>
        </div>
      </template>
      <div id="s-box"></div>
      <div id="o-box"></div>
      <div id="e-box"></div>
      <div id="p-box"></div>
    </div>
  </main>

  <!-- Dependencies -->
  <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>

  <!-- Utilities -->
  <script>
    function toggleMenu() {
      document.getElementById('dropdown-menu').classList.toggle('hidden');
    }
    function formatBullets(text) {
      return '<ul>' + text.split('‚Ä¢').slice(1).map(s=>s.trim()).filter(Boolean).map(i=>`<li>${i}</li>`).join('') + '</ul>';
    }
    function createSection(letter, content) {
      const tmpl = document.getElementById('section-template').content.cloneNode(true);
      tmpl.querySelector('h3').textContent = letter;
      const out = tmpl.querySelector('.formatted-output');
      out.innerHTML = formatBullets(content.replace(/-\s*/g,'‚Ä¢ '));
      tmpl.querySelector('button').onclick = () => navigator.clipboard.writeText(out.innerText);
      return tmpl;
    }
    document.querySelectorAll('.expanding-textarea').forEach(t=> {
      const adjust = ()=>{ t.style.height='auto'; t.style.height=Math.min(t.scrollHeight,640)+'px'; };
      t.addEventListener('input',adjust); adjust();
    });
  </script>

  <!-- SOEP Generation -->
  <script>
    document.getElementById('generate-soep').onclick = async () => {
      const txt = document.getElementById('text-input').value.trim();
      if (!txt) return alert('Transcriptie of tekst ontbreekt.');
      const loader = document.getElementById('loading-overlay');
      const btn = document.getElementById('generate-soep');
      loader.style.display='flex'; btn.disabled=true;
      try {
        const res = await fetch('https://ceccf3b52de9.ngrok-free.app/generate-soep', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({prompt:txt})
        });
        const data = await res.json();
        if(data.error) throw new Error(data.error);
        ['S','O','E','P'].forEach(l=>{
          const box=document.getElementById(l.toLowerCase()+'-box');
          box.innerHTML=''; box.appendChild(createSection(l,data[l.toLowerCase()]));
        });
        document.getElementById('verslag-container').classList.remove('hidden');
        document.getElementById('verslag-container').scrollIntoView({behavior:'smooth',block:'start'});
      } catch(e) {
        console.error(e); alert('Serverfout bij SOEP-generatie.');
      } finally {
        loader.style.display='none'; btn.disabled=false;
      }
    };
  </script>

  <!-- Waveform Animation -->
  <script>
    const NUM_BARS=40; let animId;
    function initWaveform(stream) {
      const c=document.getElementById('waveform-canvas'), ctx=c.getContext('2d');
      const ac=new (window.AudioContext||window.webkitAudioContext)(),
            an=ac.createAnalyser(); an.fftSize=1024;
      ac.createMediaStreamSource(stream).connect(an);
      const data=new Uint8Array(an.frequencyBinCount);
      (function draw(){
        animId=requestAnimationFrame(draw);
        an.getByteTimeDomainData(data);
        ctx.clearRect(0,0,c.width,c.height);
        const w=c.width/NUM_BARS;
        for(let i=0;i<NUM_BARS;i++){
          const v=data[i*Math.floor(data.length/NUM_BARS)]/255*c.height*0.4;
          ctx.beginPath(); ctx.moveTo(i*w+w/2,c.height/2-v/2);
          ctx.lineTo(i*w+w/2,c.height/2+v/2); ctx.stroke();
        }
      })();
    }
    function cancelWaveform(){ if(animId) cancelAnimationFrame(animId); }
  </script>

  <!-- Live PCM capture -->
  <script>
    const SOCKET_URL='https://ceccf3b52de9.ngrok-free.app';
    const socket=io(SOCKET_URL,{transports:['websocket']});
    const startBtn=document.getElementById('whisper-btn'),
          cancelBtn=document.getElementById('cancel-recording-btn'),
          soepBtn=document.getElementById('soep-recording-btn'),
          overlay=document.getElementById('recording-overlay');
    let audioCtx,procNode,stream, isCancel=false;

    startBtn.onclick = async () => {
      isCancel=false;
      socket.emit('start-audio');
      stream = await navigator.mediaDevices.getUserMedia({audio:true});
      audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      const src=audioCtx.createMediaStreamSource(stream);
      procNode=audioCtx.createScriptProcessor(4096,1,1);
      src.connect(procNode); procNode.connect(audioCtx.destination);
      procNode.onaudioprocess = e => {
        if(isCancel) return;
        socket.emit('stream-audio', e.inputBuffer.getChannelData(0).buffer);
      };
      overlay.classList.remove('hidden');
      startBtn.disabled=true;
      initWaveform(stream);
    };

    cancelBtn.onclick = () => {
      isCancel=true;
      socket.emit('end-audio');
      procNode.disconnect();
      audioCtx.close();
      stream.getTracks().forEach(t=>t.stop());
      overlay.classList.add('hidden');
      startBtn.disabled=false;
      cancelWaveform();
    };

    soepBtn.onclick = () => {
      socket.emit('end-audio');
      overlay.classList.add('hidden');
      startBtn.disabled=false;
      cancelWaveform();
      // Hier kun je eventueel direct generateSOEP() aanroepen
    };

    socket.on('transcription-partial', ({text}) => {
      document.getElementById('text-input').value += text;
    });
    socket.on('transcription-error', ({error}) => {
      console.error(error); alert('Transcriptie-fout: '+error);
    });
  </script>
</body>
</html>
